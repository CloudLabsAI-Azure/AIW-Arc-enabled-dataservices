# Exercise 3: Azure Arc enabled PostgreSQL Hyperscale

Duration: -

In this exercise, you will create a Postgres Hyperscale Server group and data operations on Postgres DB

## Task 1: Create a Postgres Hyperscale Server group and connect to the Azure Arc enabled PostgreSQL Hyperscale server group

1. In the Azure Arc Data Controller dashboard, click on **+ New Instance**.

1. From the deployment options blade, select PostgreSQL Hyperscale server group - Azure Arc. Accept the Privacy and license terms and click **Select** at the bottom.

     ![](images/postgresql.png "Confirm")

1. In the Deploy PostgreSQL Hyperscale server group - Azure Arc blade, enter the following information:

   **Under General settings**
   
   - **Server group name**: Enter arcpostgres 
   
   - **Password**: Enter Password.1!!
   
   - **Number of workers**: Enter 3
   
   - **Port**: Leave it default
    
     ![](images/generalsettings.png "generalsettings")
   
   **Under Resource settings**
  
   - **CPU request**: Enter 2
   
   - **CPU limit**: Enter 2.5
   
   - **Memory request**: Enter 2.5
   
   - **Memory limit**: Enter 2.5
   
     ![](images/resourcesetting.png "resourcesettings")
   
1. Click the **Deploy** button. This starts the creation of the Azure Arc enabled PostgreSQL Hyperscale server group on the data controller.

   ![](images/deploy.png "deploy")
   
1. Now in **Configure Python Runtime** blade, under **Installation Type** select New Python installation and click on **Next**.

   ![](images/pythoninstalation.png "")

1. In **Install Dependencies** blade click on **Install**. 

   ![](images/pythoninstalation2.png "")
   
1. Once the installation is complete, in **Azure Arc Data Controller dashboard** under Azure Arc Resources you can see the newly created Postgres Hyperscale Server group.

   ![](images/arcpostgres.png "")


**Connect on-premise source database and Azure Arc enabled PostgreSQL server**

1. In the command prompt run the following to get the Postgres servers list in AKS using the Azure Arc data controller. 
   
   ```BASH
   azdata arc postgres server list
   ```
  
   ```BASH
   Name        State    Workers
   ----------  -------  ---------
   postgres01  Ready    2

   ```

2. To get connection string details for postgres01 server endpoint run the following command.

   ```BASH
   azdata arc postgres endpoint list -n postgres01
   ```

   ```BASH
   Arc
   ======================================================================================================================
   Postgres01 Instance
   ----------------------------------------------------------------------------------------------------------------------
   Description           Endpoint

   PostgreSQL Instance   postgresql://postgres:<replace with password>@40.121.8.176:5432
   Log Search Dashboard  https://40.117.233.178:30777/kibana/app/kibana#/discover?_a=(query:(language:kuery,query:'custom_resource_name:postgres01'))
   Metrics Dashboard     https://40.117.233.178:30777/grafana/d/postgres-metrics?var-Namespace=arc&var-Name=postgres01

   ```
3. On your LabVM open the PgAdmin tool from the start menu to connect Azure arc enabled Postgres Hyperscale database 

   ![](./images/pg-connect-arc-db.png "")

4. Now connect Azure arc enabled Postgres server using above connection string details.

   ![](./images/pg-add-arc-db.png "")

5. Under the connection tab enter the below details from the above connection string details similar to the following one.

    ```BASH
   PostgreSQL Instance   postgresql://postgres:<replace with password>@40.121.8.176:5432
   ```

   ![](./images/pg-add-arc-db02.png "")


## Task 2: Backup/Restore and Review the distribution of data 

1. On your LabVM launch a Command Prompt window Select search on the taskbar, type cmd, and select Enter.

**Verify configuration**

2. First, we need to verify that our server group has been configured to use backup storage class.
   ```BASH
   azdata arc postgres server show -n arcpostgres
   ```
   Look at the storage section of the output:
   ```BASH 
   "service": {
         "port": 5432,
         "type": "LoadBalancer"
      },
      "storage": {
         "backups": {
         "className": "default",
         "size": "5Gi"
         },
         "data": {
         "className": "default",
         "size": "5Gi"
         },
         "logs": {
         "className": "default",
         "size": "5Gi"
         }
      }
   ```
**Take a manual full backup**

3. To take a full backup of the entire data and log folders of our server group by running the following command:
   ```BASH
   azdata arc postgres backup create --name backup14122020-0408pm --server-name arcpostgres
   ```
   This command will coordinate a distributed full backup across all the nodes that constitute our Azure Arc enabled PostgreSQL Hyperscale server group.

   Where:
   - **name** indicates the name of a backup
   - **server-name** indicates a server group

   When the backup completes, the ID, name, size, state, and timestamp of the backup will be returned.
   ```BASH
   {
   "ID": "7212353a05ee45dca542da2add498270",
   "name": "backup14122020-0408pm",
   "size": "21.11 MiB",
   "state": "Done",
   "timestamp": "2020-12-14 10:39:27+00:00"
   }
   ```

   ![](images/bkp_rslt.PNG "")

   In the above result, "+00:00" means UTC time (UTC + 00 hour 00 minutes)

**List backups**

4. To list the backups that are available to restore.
   ```BASH
   azdata arc postgres backup list --server-name arcpostgres
   ```
   Returns an output like:
   ```BASH
   ID                                Name                   Size       State    Timestamp
   --------------------------------  ---------------------  ---------  -------  -------------------------
   7212353a05ee45dca542da2add498270  backup14122020-0408pm  21.11 MiB  Done     2020-12-14 10:39:27+00:00
   ```

   ![](images/bkp_lst.PNG "")

**Restore a full backup**

5. We will restore the entire content of a backup.
   
   **Restoring the server group postgres onto itself:**
   ```BASH
   azdata arc postgres backup restore -sn postgres --backup-id 7212353a05ee45dca542da2add498270
   ```
   This operation is only supported for PostgreSQL version 12 and higher.
   
   **Restore the server group postgres to a different server group postgres01:**
   ```BASH
   azdata arc postgres backup restore -sn postgres01 -ssn postgres --backup-id 7212353a05ee45dca542da2add498270
   ```

   ![](images/bkp_rsto.PNG "")

   This example restores into server group **postgres**. Note that "+00" indicates the timezone of the point in time.

## Task 3: Configure & Scale, and review the distribution of data

1. On your LabVM launch a **Command Prompt** window (Select search on the taskbar, type cmd, and select Enter).

1. Run the following query to verify that you currently have three Hyperscale worker nodes, each corresponding to a Kubernetes pod.

   ```BASH
   azdata arc postgres server list
   ```
   
1. Now to scale-out **Azure Arc enabled PostgreSQL Hyperscale**,  in the command prompt run the following command. This will increase the number of worker nodes from 3 to 5.

   ```BASH
   azdata arc postgres server edit -n arcpostgres -w 4
   ```
  
   > **Note**: Wait for the command to complete 
  
1. Run the following command and verify that the server group is now using the additional worker nodes you added. In the output, you should be able to see 5 worker nodes.
   
   ```BASH
   azdata arc postgres server list
   ```

1. Once the nodes are available, the Hyperscale Shard Rebalancer runs automatically and redistributes the data to the new nodes. The scale-out operation is an online operation. While the nodes are added and the data is redistributed across the nodes, the data remains available for queries.

1. You can also scale up, from **PostgreSQL Hyperscale - Azure Arc Dashboard**. 

## Task 4: Monitor/Visualize with Azure Data Studio Dashboards

Now that you are connected to a data controller, you can view the dashboards for the data controller and any SQL managed instances or PostgreSQL Hyperscale server group resources that you have.

1. In the **Connections** panel, under **Arc Controllers** right-click on the  arcdc data controller and select **Manage**.

   ![](./images/Mondata-studio01.PNG "")

1. In the Azure Arc Data Controller dashboard, you can see Grafana and Kibana Dashboard URLs along with details about the data controller resource.

   ![](./images/arc-dash.PNG "")

   Kibana and Grafana web dashboards are provided to bring insight and clarity to the Kubernetes namespaces being used by Azure Arc enabled data services. 

1. Click on the Grafana service endpoints to open the grafana dashboard. The relevant Grafana dashboards are:

   - "Azure SQL managed instance Metrics"
   - "Host Node Metrics"
   - "Host Pods Metrics"


1. Open Azure Data studio on Jumpbox and right click on the Postgres server reosurce under Azure Arc controller and click on manage.
  
  1. Now copy the endpoint for Kibana dashboard and browser this endpoint in a browser.
  
  1. Enter below user name and password for SQLMI.
  
   - **Note** You have to enter the credentials of Azure Arc data controller.

   ![](images/sql-mon-kibana-login.png "")
  
     - **User name** : Enter arcuser
   
     - **Password** : Enter Password.1!!
   
   ![](images/sql-mon-kibana.png "")


  1. You can explore the page for kibana. 
  
    - You can learn more about kibana here : https://docs.microsoft.com/en-us/azure/azure-arc/data/monitor-grafana-kibana
    
  ## View the Visualization and metric using grafana graph
  
   1. Open Azure Data studio on Jumpbox and right click on the Postgres server reosurce under Azure Arc controller and click on manage.
  
  1. Now copy the endpoint for Grafana dashboard and browser this endpoint in a browser.
  
  1. Enter below user name and password for SQLMI.
  
   - **Note** You have to enter the credentials of Azure Arc data controller.

   ![](./images/Mon-grafana-login.PNG "")
  
     - **User name** : Enter arcuser
   
     - **Password** : Enter Password.1!!

     ![](./images/grafana-dashboard.PNG "")
   
  1. You can explore the page for Grafana. 
  
    - You can learn more about Grafana here : https://docs.microsoft.com/en-us/azure/azure-arc/data/monitor-grafana-kibana

## Task 5: How to migrate from different on-premises/cloud server?

Azure Arc enabled PostgreSQL Hyperscale server group is the community version of PostgreSQL and runs with the CitusData extension enabled

- Source:
   A Postgres Server running on-premises on a bare metal server and named Postgres. It is version 13 and hosts a database named Arc-Demo-PG that has 4 tables.

- Destination:
   A Postgres server running in an Azure Arc environment and named postgres01. It is version 13. It does not have any database except the standard Postgres database.

**Take a backup of the source database on-premises**

   ![](./images/pg-source-db.png "")

   Configure it:

   1. Give it a file name: Arc-Demo-Bkp

   ![](./images/pg-source-db-backup.png "")

   1. Set the format to Custom

   ![](./images/pg-source-db-backup01.png "")

   1. The backup completes successfully:

**Create an empty database on the destination system in your Azure Arc enabled PostgreSQL Hyperscale server group**

   1. Select Create option from postgres01 database menu

   ![](./images/pg-dest-db-create.png "")

   2. Let's name the destination database Restored_Arc-Demo-PG

   ![](./images/pg-dest-db-create02.png "")

**Restore the database in your Arc setup**

   Configure the restore:

   1. Point to the file that contains the backup to restore: Arc-Demo-Bkp

   ![](./images/pg-dest-db-restore.png "")

   2. Keep the format set to Custom or tar

   3. Click Restore.
   
   ![](./images/pg-dest-db-restore.png "")
      The restore is successful.

**Verify that the database was successfully restored in your Azure Arc enabled PostgreSQL Hyperscale server group**

   Test from psql inside our Azure Arc setup:

   Within your Arc setup you can use PgAdmin to connect to your Postgres instance, select database RESTORED_Arc-Demo-PG and query the data:

   ![](./images/pg-dest-db-check.png "")

   - Right-click on Database and select Query tool to open a new query window and use the below query to see the results of **pgbench_accounts** table and you'll see the data that you restored from the on-premises Postgres instance:

   ```BASH
   select * from Public.pgbench_accounts;
   ```

## Task 6: Create Log anaytics workspace to upload logs, metric and usages to Azure Monitor. 

In this task you will create a log analytics workspace to upload logs for your Azure Arc enabled SQL managed instances and Azure Arc enabled PostgreSQL Hyperscale server groups to Azure Monitor and view your logs in Azure portal

1. In the command prompt run the following command to login to azure. On the sign-in page enter the username and password, you can find the username and password from the environment details tab.

   ```BASH
   az login
   ```

   ![](./images/Az-login.PNG "")

1. In the command prompt run the following command to create a log analytics workspace. 

   >**Note**: Please make sure to replace the resource group name and workspace name. You can find resource group name from the environment details tab and for workspace name enter a globally unique value.

   ```BASH
   az monitor log-analytics workspace create --resource-group <resource group name> --workspace-name <Unique name of workspace>
   ```

   ![](./images/Create-logWorkspace.PNG "")

   
1. From the output window copy the **customerID** value and save the value locally in the text file, you will use these values in the later part of the lab.


1. Now run the following command to retrieve the access keys required to connect to your log analytics workspace. Make sure to replace resource group name and workspace name

   ```BASH
     az monitor log-analytics workspace get-shared-keys --resource-group MyResourceGroup --workspace-name <Unique name of workspace>
   ```

   ![](./images/LogWorkspace-Keys.PNG "")
   
1. From the output window copy the **"primarySharedKey** value and save the value locally in the text file, you will use these values in the later part of the lab.

1. In the command prompt, replace the **customerId**, **primarySharedKey** in the following command with the values which you copied earlier and run it. This command saves the customerId and primarySharedKey values in an environment variable to use later in the lab.

   ```BASH
   SET WORKSPACE_ID=<customerId>
   SET WORKSPACE_SHARED_KEY=<primarySharedKey>
   ```

   ![](./images/Set-LogWorkspace-IDKeys.PNG "")

1. Run the following command to set the SPN authority URL in an environment variable.

   ```BASH
   SET SPN_AUTHORITY=https://login.microsoftonline.com
   ```

   ![](./images/Set-client-IDs.PNG "")

1. Now run the following command to make sure that all environment variables required are set.

   ```BASH
   echo %WORKSPACE_ID%
   echo %WORKSPACE_SHARED_KEY%
   echo %SPN_TENANT_ID%
   echo %SPN_CLIENT_ID%
   echo %SPN_CLIENT_SECRET%
   echo %SPN_AUTHORITY%
   ```
  - **Note**: We have already added the variables of Service principal details, So you dont have to add these variables value.
   ![](./images/Echo-env-var.PNG "")

1. Now you have created the **Log Analytics workspaces** but you can't upload any usages or logs. we will be uploading the Logs and usages in Next exercises.  
   
## After this exercise, you have learned the following,
   - create a Postgres Hyperscale Server group.
   - Backup/Restore and Review the distribution of data.
   - Configure & Scale, and review the distribution of data.
   - Monitor/Visualize with Azure Data Studio Dashboards.
   - How to migrate from different on-premises/cloud server.
   - Upload usage data, metrics, and logs to Azure Monitor.
