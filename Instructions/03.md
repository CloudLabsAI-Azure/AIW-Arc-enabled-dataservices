# Exercise 3: Azure Arc enabled PostgreSQL Hyperscale

Duration: -

In this exercise, you will create a Postgres Hyperscale Server group

## Task 1: Create a Postgres Hyperscale Server group and connect to the Azure Arc enabled PostgreSQL Hyperscale server group

1. In the Azure Arc Data Controller dashboard, click on **+ New Instance**.

1. From the deployment options balde, select PostgreSQL Hyperscale server group - Azure Arc. Accept the Privacy and license terms and click **Select** at the bottom.

     ![](images/postgresql.png "Confirm")

1. In the Deploy PostgreSQL Hyperscale server group - Azure Arc blade, enter the following information:

   **Under Genral settings**
   
   - **Server group name**: Enter arcpostgres 
   
   - **Password**: Enter Password.1!!
   
   - **Number of workers**: Enter 3
   
   - **Port**: Leave it default
    
     ![](images/generalsettings.png "generalsettings")
   
   **Under Resource settings**
  
   - **CPU request**: Enter 2
   
   - **CPU limit**: Enter 2.5
   
   - **Memory request**: Enter 2.5
   
   - **Memory limit**: Enter 2.5
   
     ![](images/resourcesetting.png "resourcesettings")
   
1. Click the **Deploy** button. This starts the creation of the Azure Arc enabled PostgreSQL Hyperscale server group on the data controller.

   ![](images/deploy.png "deploy")
   
1. Now in **Configure Python Runtime** blade, under **Installation Type** select New Python installation and click on **Next**.

   ![](images/pythoninstalation.png "")

1. In **Install Dependencies** blade click on **Install**. 

   ![](images/pythoninstalation2.png "")
   
1. Once the installation is complete, in **Azure Arc Data Controller dashboard** under Azure Arc Resources you can see the newly created Postgres Hyperscale Server group.

   ![](images/arcpostgres.png "")

## Task 2: Backup/Restore and Review the distribution of data 

1. On your LabVM launch a Command Prompt window Select search on the task bar, type cmd, and select Enter.

**Verify configuration**

2. First, we need to verify that our server group has been configured to use backup storage class.
   ```BASH
   azdata arc postgres server show -n postgres
   ```
   Look at the storage section of the output:
   ```BASH 
   "service": {
         "port": 5432,
         "type": "LoadBalancer"
      },
      "storage": {
         "backups": {
         "className": "default",
         "size": "5Gi"
         },
         "data": {
         "className": "default",
         "size": "5Gi"
         },
         "logs": {
         "className": "default",
         "size": "5Gi"
         }
      }
   ```
**Take a manual full backup**

3. To take a full backup of the entire data and log folders of our server group by runing the following command:
   ```BASH
   azdata arc postgres backup create --name backup14122020-0408pm --server-name postgres
   ```
   This command will coordinate a distributed full backup across all the nodes that constitute our Azure Arc enabled PostgreSQL Hyperscale server group.

   Where:
   - **name** indicates the name of a backup
   - **server-name** indicates a server group

   When the backup completes, the ID, name, size, state and timestamp of the backup will be returned.
   ```BASH
   {
   "ID": "7212353a05ee45dca542da2add498270",
   "name": "backup14122020-0408pm",
   "size": "21.11 MiB",
   "state": "Done",
   "timestamp": "2020-12-14 10:39:27+00:00"
   }
   ```

   ![](images/bkp_rslt.PNG "")

   In the above result, "+00:00" means UTC time (UTC + 00 hour 00 minutes)

**List backups**

4. To list the backups that are available to restore.
   ```BASH
   azdata arc postgres backup list --server-name postgres
   ```
   Returns an output like:
   ```BASH
   ID                                Name                   Size       State    Timestamp
   --------------------------------  ---------------------  ---------  -------  -------------------------
   7212353a05ee45dca542da2add498270  backup14122020-0408pm  21.11 MiB  Done     2020-12-14 10:39:27+00:00
   ```

   ![](images/bkp_lst.PNG "")

**Restore a full backup**

5. We will restore the entire content of a backup.
   
   **Restoring the server group postgres onto itself:**
   ```BASH
   azdata arc postgres backup restore -sn postgres --backup-id 7212353a05ee45dca542da2add498270
   ```
   This operation is only supported for PostgreSQL version 12 and higher.
   
   **Restore the server group postgres to a different server group postgres01:**
   ```BASH
   azdata arc postgres backup restore -sn postgres01 -ssn postgres --backup-id 7212353a05ee45dca542da2add498270
   ```

   ![](images/bkp_rsto.PNG "")

   This example restores into server group **postgres**. Note that "+00" indicates the timezone of the point in time.

## Task 3: Configure & Scale, and review the distribution of data

1. On your LabVM  launch a **Command Prompt** window (Select search on the task bar, type cmd, and select Enter).

1. Run the following query to verify that you currently have three Hyperscale worker nodes, each corresponding to a Kubernetes pod.

   ```BASH
   azdata arc postgres server list
   ```
   
1. Now to scale out **Azure Arc enabled PostgreSQL Hyperscale**,  in the command prompt run the following command. This will increase the number of worker nodes from 3 to 5.

   ```BASH
   azdata arc postgres server edit -n arcpostgres -w 4
   ```
  
   > **Note**: Wait for the command to complete 
  
1. Run the following command and verify that the server group is now using the additional worker nodes you added. In the output you should be able to see 5 worker nodes.
   
   ```BASH
   azdata arc postgres server list
   ```

1. Once the nodes are available, the Hyperscale Shard Rebalancer runs automatically, and redistributes the data to the new nodes. The scale-out operation is an online operation. While the nodes are added and the data is redistributed across the nodes, the data remains available for queries.

1. You can also scale up, from **PostgreSQL Hyperscale - Azure Arc Dashboard**. 

## Task 4: Monitor/Visualize with Azure Data Studio Dashboards

## Task 5: How to migrate from different cloud?
